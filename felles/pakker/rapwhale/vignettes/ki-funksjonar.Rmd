---
title: "Kvalitetsindikatorfunksjonar"
author: "Karl Ove Hufthammer"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Kvalitetsindikatorfunksjonar}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r pakkelasting, include = FALSE}
suppressPackageStartupMessages({
  library(dplyr)
  library(rapwhale)
})
```

# Innleiing

Ved utrekning av kvalitetsindikatorar er det mange fallgruver å gå i.
Me har derfor utvikla eit rammeverk for korleis dette skal gjerast.
Ved hjelp av ein fastsett metodikk og eit tilhøyrande sett R-funksjonar
reduserer me risikoen for at indikatorane vert rekna ut feil,
og me gjer det raskare og enklare å bruka indikatorane i ulike situasjonar.

Det er greiast å visa rammeverket via nokre eksempel:

# Eksempel – eittårsoppfølging

Me har eit enkelt register der pasientar vert opererte og
seinare følgde opp. Nokre av variablane i registeret kan sjå slik ut:

```{r lageksempel, echo = FALSE}
dato_uthenting = Sys.Date()
dato_uthenting_tekst = format(dato_uthenting, "%e. %b %Y")
forskyvingsdagar = as.numeric(dato_uthenting) - 18239 # Magisk tal for å flytta datoar nærare notida
d_reg = tibble::tribble(
  ~pas_id, ~kjonn, ~alder, ~sjukehus, ~dato_operasjon, ~dato_oppfolging,
  11L, "mann", 18, "A", "2018-02-01", "2019-01-15",
  13L, "kvinne", 36, "C", "2019-04-07", NA,
  14L, "mann", 25, "B", "2018-04-13", "2019-09-17",
  27L, "kvinne", 29, "A", "2018-07-28", "2019-07-02",
  28L, "mann", 78, "B", "2018-07-26", "2019-11-11",
  29L, "mann", 45, "B", "2018-03-19", NA
) %>%
  mutate(
    kjonn = factor(kjonn),
    sjukehus = factor(sjukehus),
    dato_operasjon = as.Date(dato_operasjon) + forskyvingsdagar,
    dato_oppfolging = as.Date(dato_oppfolging) + forskyvingsdagar
  )
print(d_reg)
```

Pasientane skal helst følgjast opp innan eitt år etter operasjon,
og me har ein eigen kvalitetsindikator for dette. Der er det blant
anna definert at «eitt år» skal reknast som 365 dagar.

## Første forsøk på utrekning

Viss me vart bedt om å rekna ut kvalitetsindikatoren, ville me kanskje
gjort det slik:

```{r}
sum(d_reg$dato_oppfolging - d_reg$dato_operasjon <= 365, na.rm = TRUE) / nrow(d_reg)
```

Så det ser ut til at berre ein tredel av pasientane får oppfølging innan fristen.

Det er dessverre fleire problem  utrekninga.
For det første er svaret feil!
Merk at pasient 13 har `NA` for oppfølgingsdato,
som tyder at ho enno ikkje er følgd opp.
Sidan det var under eit år sidan operasjonen
(la oss anta at dagens dato er `r dato_uthenting_tekst`),
skal ho ekskluderast frå utrekninga.
Det vert ho i utrekninga av teljaren (`na.rm = TRUE`),
men ikkje i utrekninga av nemnaren (`nrow(d_reg)`),
så brøken vert feil.

Dette er eksempel på ein feil som lett kan oppstå når utrekninga
av teljaren og nemnaren vert gjort på ulike datakjelder.
Spesielt er det stor risiko viss det er snakk om to ulike *datarammer*
(så det bør ein *aldri* bruka!).

## Andre forsøk på utrekning

Problemet med to ulike datakjelder er lett å retta opp.
Me kan for eksempel skriva det slik:

```{r}
mean(d_reg$dato_oppfolging - d_reg$dato_operasjon <= 365, na.rm = TRUE)
```

Så halvparten får oppfølging innan fristen. Mykje betre!
Problemet er at svaret framleis er feil!

Pasient 29 vert ekskludert frå utrekninga, men me ser at han
vart operert for godt over eit år sidan og har *ikkje* fått oppfølging
enno (altså per `r dato_uthenting_tekst`).
Han bør altså reknast som ein som ikkje fekk oppfølging innan fristen.
Og i motsetning til pasient 13, bør han *ikkje* ekskluderast frå
utrekninga.

fixme: eksempel på rammeverket  
fixme: skriva om difftime()  
fixme: fordeling på sjukehus  
fixme: nemna 0/0  
